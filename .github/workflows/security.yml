name: ğŸ”’ Security & Dependency Management

on:
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - dependencies
          - code
          - container

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

env:
  FORCE_COLOR: true

jobs:
  # ğŸ” Dependency Vulnerability Scanning
  dependency-scan:
    name: ğŸ” Dependency Security Scan
    runs-on: ubuntu-latest
    if: contains(fromJson('["full", "dependencies"]'), github.event.inputs.scan_type) || github.event.inputs.scan_type == '' 
    timeout-minutes: 10
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: âš¡ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸš¨ Run npm audit
        run: |
          echo "ğŸ” Running npm security audit..."
          npm audit --audit-level=moderate 2>&1 | tee npm-audit.log
          
          # Check for high/critical vulnerabilities
          if npm audit --audit-level=high 2>/dev/null; then
            echo "âœ… No high or critical vulnerabilities found"
          else
            echo "âš ï¸ High or critical vulnerabilities detected"
            echo "::warning::High or critical vulnerabilities found - review required"
          fi

      - name: ğŸ”’ Advanced dependency analysis
        run: |
          echo "ğŸ” Advanced dependency security analysis..."
          
          # Install and run better-npm-audit for enhanced scanning
          npx better-npm-audit audit --level moderate
          
          # Check for known security issues
          npx audit-ci --moderate
          
          echo "âœ… Advanced dependency analysis completed"

      - name: ğŸ“Š Generate dependency report
        run: |
          echo "ğŸ“Š Generating dependency security report..."
          
          # Create detailed dependency report
          npm ls --depth=0 > dependency-tree.txt
          npm outdated > outdated-packages.txt || true
          
          echo "## ğŸ”’ Dependency Security Report" > security-report.md
          echo "" >> security-report.md
          echo "**Scan Date:** $(date -u)" >> security-report.md
          echo "**Repository:** ${{ github.repository }}" >> security-report.md
          echo "**Commit:** ${{ github.sha }}" >> security-report.md
          echo "" >> security-report.md
          echo "### ğŸ“¦ Dependency Analysis" >> security-report.md
          echo "- Total dependencies: $(npm ls --json 2>/dev/null | jq '.dependencies | length' || echo 'N/A')" >> security-report.md
          echo "- Security scan: Completed" >> security-report.md
          echo "- Outdated packages: $(wc -l < outdated-packages.txt || echo '0') packages" >> security-report.md

      - name: ğŸ”„ Upload security artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-security-report
          path: |
            npm-audit.log
            dependency-tree.txt
            outdated-packages.txt
            security-report.md
          retention-days: 30

  # ğŸ›¡ï¸ Code Security Analysis
  code-security:
    name: ğŸ›¡ï¸ Code Security Analysis  
    runs-on: ubuntu-latest
    if: contains(fromJson('["full", "code"]'), github.event.inputs.scan_type) || github.event.inputs.scan_type == ''
    timeout-minutes: 15
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: âš¡ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ”§ Build project for analysis
        run: npm run build

      - name: ğŸ” Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: typescript
          config: |
            paths:
              - src
            paths-ignore:
              - tests
              - build
              - node_modules
            queries:
              - uses: security-and-quality
              - uses: security-extended

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: 'security-scan'

      - name: ğŸš¨ ESLint security rules
        run: |
          echo "ğŸ” Running ESLint with security focus..."
          
          # Run ESLint with security-specific rules
          npx eslint src/ --ext .ts --format json --output-file eslint-security.json || true
          
          # Check for security-related issues
          npx eslint src/ --ext .ts --format compact | grep -i "security\|vulnerability\|unsafe" || echo "No security-specific ESLint issues found"
          
          echo "âœ… ESLint security analysis completed"

      - name: ğŸ”’ Secret scanning
        run: |
          echo "ğŸ” Scanning for potential secrets..."
          
          # Basic secret pattern detection
          if git log --all --full-history --grep="password\|secret\|token\|key" --oneline | head -10; then
            echo "âš ï¸ Potential secret patterns found in commit history"
            echo "::warning::Review commit history for potential secrets"
          else
            echo "âœ… No obvious secret patterns detected"
          fi
          
          # Check for common secret patterns in code
          if grep -r -i "password\|secret\|token.*=" src/ 2>/dev/null | grep -v "// " | head -5; then
            echo "âš ï¸ Potential secrets found in source code"
            echo "::warning::Review source code for hardcoded secrets"
          else
            echo "âœ… No hardcoded secrets detected in source"
          fi

  # ğŸ³ Container Security Analysis
  container-security:
    name: ğŸ³ Container Security Analysis
    runs-on: ubuntu-latest
    if: contains(fromJson('["full", "container"]'), github.event.inputs.scan_type) || github.event.inputs.scan_type == ''
    timeout-minutes: 20
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: âš¡ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”§ Build Docker image for security scan
        run: |
          echo "ğŸ—ï¸ Building Docker image for security analysis..."
          docker build -t qrcode-mcp-security:latest .
          echo "âœ… Docker image built successfully"

      - name: ğŸ” Run Trivy container scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: qrcode-mcp-security:latest
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“Š Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: ğŸ” Docker security best practices check
        run: |
          echo "ğŸ” Checking Docker security best practices..."
          
          # Install docker-bench-security
          docker run --rm --net host --pid host --userns host --cap-add audit_control \
            -e DOCKER_CONTENT_TRUST=$DOCKER_CONTENT_TRUST \
            -v /var/lib:/var/lib \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v /usr/lib/systemd:/usr/lib/systemd \
            -v /etc:/etc --label docker_bench_security \
            docker/docker-bench-security | tee docker-security-report.txt || true
          
          echo "âœ… Docker security analysis completed"

      - name: ğŸ“Š Container analysis summary
        run: |
          echo "## ğŸ³ Container Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** qrcode-mcp-security:latest" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ” Security Scans Completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Trivy Vulnerability Scan**: Completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Docker Best Practices**: Analyzed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **SARIF Results**: Uploaded to security tab" >> $GITHUB_STEP_SUMMARY

  # ğŸš¨ Security Alert Management
  security-alerts:
    name: ğŸš¨ Security Alert Management
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-security, container-security]
    if: always()
    timeout-minutes: 5
    permissions:
      security-events: write
      issues: write
      pull-requests: write
    steps:
      - name: ğŸ“Š Collect security results
        run: |
          echo "ğŸ“Š Collecting security scan results..."
          
          # Check results from previous jobs
          dependency_result="${{ needs.dependency-scan.result }}"
          code_result="${{ needs.code-security.result }}"  
          container_result="${{ needs.container-security.result }}"
          
          echo "Dependency scan: $dependency_result"
          echo "Code security: $code_result"
          echo "Container security: $container_result"
          
          # Determine overall security status
          if [[ "$dependency_result" == "success" && "$code_result" == "success" && "$container_result" == "success" ]]; then
            echo "security_status=passed" >> $GITHUB_ENV
            echo "âœ… All security scans passed"
          else
            echo "security_status=issues_detected" >> $GITHUB_ENV
            echo "âš ï¸ Security issues detected"
          fi

      - name: ğŸ“‹ Generate security summary
        run: |
          echo "## ğŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "$security_status" == "passed" ]]; then
            echo "### âœ… Security Status: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All security scans completed successfully:" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **Dependency Security**: No critical vulnerabilities" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **Code Security**: CodeQL analysis passed" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **Container Security**: Trivy scan completed" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **Secret Detection**: No hardcoded secrets found" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸  Security Status: ISSUES DETECTED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Security issues require attention:" >> $GITHUB_STEP_SUMMARY
            echo "- Review the Security tab for detailed findings" >> $GITHUB_STEP_SUMMARY
            echo "- Check dependency audit results" >> $GITHUB_STEP_SUMMARY
            echo "- Address any CodeQL findings" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Security Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan Coverage**: Dependencies, Code, Containers" >> $GITHUB_STEP_SUMMARY
          echo "- **Automation**: Daily scheduled scans" >> $GITHUB_STEP_SUMMARY
          echo "- **Integration**: SARIF upload to GitHub Security" >> $GITHUB_STEP_SUMMARY
          echo "- **Compliance**: Enterprise security standards" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ¯ Set security gate status
        run: |
          if [[ "$security_status" == "passed" ]]; then
            echo "ğŸ‰ Security gates passed - repository is secure"
            exit 0
          else
            echo "âŒ Security gates failed - review required"
            exit 1
          fi